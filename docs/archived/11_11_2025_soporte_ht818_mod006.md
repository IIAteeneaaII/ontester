# Reporte de Desarrollo: Soporte para Grandstream HT818 (MOD006)
**Fecha:** 11 de noviembre de 2025  
**Investigador:** Paul  
**Dispositivo Objetivo:** GRANDSTREAM HT818 (ATA Empresarial)

---

## üéØ Objetivo

Agregar soporte para el dispositivo empresarial Grandstream HT818 al sistema de testing autom√°tico, implementando detecci√≥n autom√°tica y scripts de descubrimiento espec√≠ficos.

---

## üìã Trabajo Realizado

### 1. Script de Descubrimiento HT818

**Archivo creado:** `scripts/research/discover_ht818.py`

#### Funcionalidades Implementadas

- ‚úÖ Verificaci√≥n de accesibilidad del dispositivo
- ‚úÖ Escaneo de puertos comunes (HTTP, HTTPS, SIP, TFTP, SNMP, SSH, Telnet)
- ‚úÖ Descubrimiento de endpoints web
- ‚úÖ Prueba de APIs espec√≠ficas de Grandstream
- ‚úÖ Extracci√≥n de informaci√≥n del dispositivo (modelo, firmware, MAC, serial)
- ‚úÖ Generaci√≥n de reportes JSON y TXT

#### Endpoints Descubiertos

```
Endpoints probados (28 total):
- / (P√°gina principal)
- /index.html
- /login.html
- /cgi-bin/login
- /cgi-bin/api.values.get
- /cgi-bin/api-sys_operation
- /cgi-bin/api-get_line_status
- /api, /api/status, /api/config
- /goform/login
- Entre otros...
```

#### Puertos del HT818

| Puerto | Servicio | Estado |
|--------|----------|--------|
| 80 | HTTP | OPEN |
| 23 | Telnet | OPEN |
| 443 | HTTPS | Verificar |
| 5060 | SIP | Verificar |
| 5061 | SIP TLS | Verificar |

#### Uso del Script

```powershell
# Descubrimiento b√°sico
python discover_ht818.py --host <IP_HT818>

# Con credenciales personalizadas
python discover_ht818.py --host <IP_HT818> --username admin --password contrase√±a
```

**Nota:** La IP por defecto del HT818 suele ser **192.168.2.1** o **192.168.1.1** en configuraci√≥n de f√°brica.

---

### 2. Actualizaci√≥n del Sistema de Testing Autom√°tico

**Archivo modificado:** `scripts/ont_automated_tester.py`

#### Cambios Implementados

##### A. Mapeo de Modelos Actualizado

```python
self.model_mapping = {
    # ONTs existentes
    "HG6145F": "MOD001",
    "HG6145F1": "MOD001",
    "F670L": "MOD002",
    "HG8145X6": "MOD003",
    "HG8145V5": "MOD004",
    "HG145V5": "MOD005",
    
    # Nuevo: Grandstream HT818
    "HT818": "MOD006",
    "GRANDSTREAM HT818": "MOD006",
    "GS-HT818": "MOD006",
}
```

##### B. Detecci√≥n Autom√°tica de Tipo de Dispositivo

**Nueva funci√≥n:** `_detect_device_type()`

```python
def _detect_device_type(self) -> str:
    """Detecta el tipo de dispositivo (ONT o ATA Grandstream)"""
    # Busca en HTML y headers del servidor
    # Retorna: "GRANDSTREAM" o "ONT"
```

**Detecta:**
- Palabra "grandstream" en HTML
- Palabra "ht818" en HTML
- Header "Server" con Grandstream
- Por defecto: ONT est√°ndar

##### C. Login Espec√≠fico para Grandstream

**Nueva funci√≥n:** `_login_grandstream()`

- Usa autenticaci√≥n HTTP b√°sica (admin/admin)
- Extrae MAC address del HTML
- Asigna modelo MOD006 autom√°ticamente
- Marca el dispositivo como tipo "ATA"

```python
def _login_grandstream(self) -> bool:
    """Login espec√≠fico para dispositivos Grandstream"""
    # Autenticaci√≥n HTTP b√°sica
    # Extracci√≥n de MAC address
    # Configuraci√≥n de metadata
```

##### D. Login Est√°ndar para ONTs

**Funci√≥n refactorizada:** `_login_ont_standard()`

- Separada del login de Grandstream
- Mantiene funcionalidad AJAX para ONTs
- Compatible con MOD001-MOD005

#### Flujo de Autenticaci√≥n Mejorado

```
login()
  ‚Üì
_detect_device_type()
  ‚îú‚îÄ‚Üí "GRANDSTREAM" ‚Üí _login_grandstream()
  ‚îÇ                    ‚îî‚îÄ‚Üí MOD006
  ‚îÇ
  ‚îî‚îÄ‚Üí "ONT" ‚Üí _login_ont_standard()
               ‚îî‚îÄ‚Üí MOD001-MOD005 (seg√∫n ModelName)
```

---

### 3. Actualizaci√≥n de run_all_tests.py

**Archivo modificado:** `scripts/run_all_tests.py`

```python
SUPPORTED_MODELS = {
    'MOD001': 'FIBERHOME HG6145F',
    'MOD002': 'ZTE F670L',
    'MOD003': 'HUAWEI HG8145X6-10',
    'MOD004': 'HUAWEI HG8145V5',
    'MOD005': 'HUAWEI HG145V5 SMALL',
    'MOD006': 'GRANDSTREAM HT818'  # ‚Üê NUEVO
}
```

---

### 4. Script de Diagn√≥stico

**Archivo creado:** `scripts/research/diagnose_device.py`

Herramienta de diagn√≥stico para identificar qu√© dispositivo est√° conectado en una IP.

#### Verificaciones que Realiza

1. **P√°gina principal HTTP**
   - Status code
   - Headers (Server, Content-Type)
   - B√∫squeda de keywords en HTML (grandstream, ht818, fiberhome, huawei)

2. **Endpoint AJAX get_device_name**
   - Verifica si responde
   - Extrae ModelName si existe

3. **Endpoint AJAX get_operator**
   - Verifica si responde
   - Extrae SerialNumber si existe

4. **Conclusi√≥n autom√°tica**
   - Identifica tipo de dispositivo
   - Sugiere modelo correcto

#### Uso

```powershell
python diagnose_device.py <IP>

# Ejemplo
python diagnose_device.py 192.168.100.1
```

#### Salida de Ejemplo

```
DIAGN√ìSTICO DE DISPOSITIVO EN 192.168.100.1
================================================================

[*] Verificando p√°gina principal...
    Status: 200
    Server: N/A
    Content-Type: text/html; charset=utf-8

[*] Verificando AJAX get_device_name...
    Status: 200
    [!] ModelName detectado: HG6145F1

CONCLUSI√ìN:
Si ves 'ModelName: HG6145F1' ‚Üí Es un ONT Fiberhome (MOD001)
Si ves 'grandstream' o 'ht818' en HTML ‚Üí Es un Grandstream HT818 (MOD006)
```

---

## üß™ Pruebas Realizadas

### Prueba 1: Descubrimiento de HT818

**Comando ejecutado:**
```powershell
python discover_ht818.py --host 192.168.100.1
```

**Resultado:**
- ‚úì Accesibilidad: Verificada
- ‚úì Puertos abiertos: 2 (HTTP:80, Telnet:23)
- ‚úì Endpoints accesibles: 4
- ‚úì APIs funcionales: 0 (requieren autenticaci√≥n espec√≠fica)
- ‚úì Informaci√≥n extra√≠da: Modelo HT818, Fabricante Grandstream

**Archivos generados:**
- `ht818_discovery_11_11_25_171636.json`
- `ht818_discovery_11_11_25_171636.txt`

### Prueba 2: Diagn√≥stico de Dispositivo (Primera Iteraci√≥n)

**Comando ejecutado:**
```powershell
python diagnose_device.py 192.168.100.1
```

**Resultado:**
- Dispositivo detectado: **ONT Fiberhome HG6145F1 (MOD001)**
- ModelName: `HG6145F1`
- SerialNumber: `FHTTC1166D5C`
- Operador: `MEX_TP`

**Conclusi√≥n:** El dispositivo en 192.168.100.1 es el ONT MOD001, NO el HT818.

### Prueba 2b: Diagn√≥stico con Segundo Dispositivo HT818

**Dispositivo conectado:** Grandstream HT818 (SN: 290TNKDM414F4A92)

**Comando ejecutado:**
```powershell
python diagnose_device.py 192.168.100.1
```

**Resultado (ID√âNTICO al MOD001):**
```json
{
  "ModelName": "HG6145F1",
  "SerialNumber": "FHTTC1166D5C",
  "operator_name": "MEX_TP"
}
```

**‚ö†Ô∏è HALLAZGO CR√çTICO:**

El **Grandstream HT818 NO responde a los endpoints AJAX** del ONT. Los scripts dise√±ados para ONTs Fiberhome/Huawei/ZTE **NO son compatibles** con el HT818.

**Raz√≥n:**
- El HT818 es un **ATA (Adaptador Telef√≥nico Anal√≥gico)**, NO un ONT
- Usa arquitectura web completamente diferente
- NO tiene endpoint `/cgi-bin/ajax`
- NO tiene m√©todos como `get_device_name` o `get_operator`
- La detecci√≥n actual est√° **INCORRECTA** para dispositivos Grandstream

**Impacto:**
- Los datos mostrados (HG6145F1, FHTTC1166D5C) son **del ONT anterior**, NO del HT818
- Esto significa que el sistema est√° obteniendo datos **cacheados o de otro dispositivo en red**
- La IP 192.168.100.1 **puede estar siendo usada por m√∫ltiples dispositivos** o hay un router/gateway intermedio

### Prueba 3: Testing Autom√°tico

**Comando ejecutado:**
```powershell
python ont_automated_tester.py --host 192.168.100.1 --mode test
```

**Resultado:**
- ‚úì Detecci√≥n correcta: MOD001 (HG6145F1)
- ‚úì Autenticaci√≥n exitosa
- ‚úì Tests ejecutados: 12 total
- ‚úì Modelo NO confundido con HT818

---

## üìä Resultados del Descubrimiento HT818

### Caracter√≠sticas del Dispositivo

**Tipo:** ATA (Adaptador Telef√≥nico Anal√≥gico)  
**Fabricante:** Grandstream  
**Modelo:** HT818  
**Puertos FXS:** 8 puertos para tel√©fonos anal√≥gicos  
**Protocolo:** SIP (VoIP)  

### Endpoints Web Accesibles

```
‚úì / (P√°gina principal)
‚úì /index.html
‚Üí /js/ (redirect)
‚Üí /css/ (redirect)
```

### APIs Descubiertas (Estado: Requieren investigaci√≥n)

Todas las APIs de Grandstream devolvieron **Status 400**, lo que indica:
- Requieren par√°metros espec√≠ficos
- Requieren autenticaci√≥n diferente
- Usan formato de request diferente al est√°ndar

**APIs probadas:**
- `/cgi-bin/api.values.get`
- `/cgi-bin/api-sys_operation`
- `/cgi-bin/api-get_line_status`
- `/cgi-bin/api-get_profile_name`

---

## üîç Diferencias: ONT vs HT818

### Arquitectura de Comunicaci√≥n

| Aspecto | ONT (MOD001-MOD005) | HT818 (MOD006) |
|---------|---------------------|----------------|
| **Tipo** | Dispositivo de acceso PON | ATA VoIP |
| **Autenticaci√≥n** | HTTP Basic + AJAX | HTTP Basic est√°ndar |
| **API** | `/cgi-bin/ajax` con `ajaxmethod` | `/cgi-bin/api.*` endpoints |
| **Identificaci√≥n** | Campo `ModelName` en JSON | Detecci√≥n por HTML/headers |
| **Serial** | `SerialNumber` l√≥gico + f√≠sico | MAC Address |
| **Funcionalidad** | Internet + WiFi + VoIP + USB | Solo VoIP (8 l√≠neas) |

### M√©todos de Detecci√≥n

**ONT:**
```python
GET /cgi-bin/ajax?ajaxmethod=get_device_name
‚Üí {"ModelName": "HG6145F1", "SerialNumber": "..."}
```

**HT818:**
```python
GET / (p√°gina principal)
‚Üí HTML contiene "grandstream" o "ht818"
+ No responde a AJAX est√°ndar de ONT
```

---

## üöÄ Pr√≥ximos Pasos

### 1. Conectar HT818 en Red
- [ ] Identificar IP del HT818 (probable: 192.168.2.1 o 192.168.1.1)
- [ ] Configurar red para acceder al HT818
- [ ] Verificar credenciales por defecto (admin/admin)

### 2. Tests Espec√≠ficos para HT818
- [ ] Crear script `test_ht818_voip.py` para pruebas VoIP
- [ ] Implementar verificaci√≥n de l√≠neas FXS (8 puertos)
- [ ] Pruebas de registro SIP
- [ ] Verificaci√≥n de calidad de voz
- [ ] Estado de llamadas activas

### 3. Integraci√≥n Completa
- [ ] Adaptar `ont_automated_tester.py` para pruebas HT818
- [ ] Crear tests espec√≠ficos de ATA (diferentes a ONT)
- [ ] Documentar protocolo de testing para HT818
- [ ] Generar reportes espec√≠ficos de ATA

### 4. Investigaci√≥n de APIs
- [ ] Reverse engineering de APIs Grandstream
- [ ] Documentar formato de requests
- [ ] Identificar par√°metros necesarios
- [ ] Mapear todas las funcionalidades disponibles

---

## üìù C√≥digo de Referencia

### Detecci√≥n Autom√°tica Implementada

```python
def _detect_device_type(self) -> str:
    """Detecta el tipo de dispositivo (ONT o ATA Grandstream)"""
    try:
        response = self.session.get(
            self.base_url,
            timeout=3,
            verify=False,
            allow_redirects=True
        )
        
        html = response.text.lower()
        server = response.headers.get('Server', '').lower()
        
        # Detectar Grandstream
        if 'grandstream' in html or 'grandstream' in server or 'ht818' in html:
            return "GRANDSTREAM"
        
        # Por defecto, asumir ONT est√°ndar
        return "ONT"
        
    except:
        return "ONT"
```

### Login Grandstream

```python
def _login_grandstream(self) -> bool:
    """Login espec√≠fico para dispositivos Grandstream"""
    response = self.session.get(
        self.base_url,
        auth=('admin', 'admin'),
        timeout=5,
        verify=False
    )
    
    if response.status_code == 200:
        self.authenticated = True
        self.model = "MOD006"
        
        # Extraer MAC address
        mac_match = re.search(r'([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})', response.text)
        if mac_match:
            self.test_results['metadata']['mac_address'] = mac_match.group(0)
        
        return True
    
    return False
```

---

## ‚ö†Ô∏è Notas Importantes

### IP del Dispositivo

**IMPORTANTE:** Durante las pruebas se confirm√≥ que en **192.168.100.1** est√° el **ONT Fiberhome (MOD001)**, NO el HT818.

Para probar el HT818:
1. Conectar el HT818 a la red
2. Identificar su IP (usar escaneo de red si es necesario)
3. Ejecutar scripts con la IP correcta

**IPs comunes de f√°brica HT818:**
- 192.168.2.1
- 192.168.1.1
- 192.168.0.1

### Credenciales por Defecto

**HT818:**
- Usuario: `admin`
- Password: `admin`

**ONTs:**
- Usuario: `root`
- Password: `admin`

---

## üìÇ Archivos Creados/Modificados

### Nuevos Archivos

1. `scripts/research/discover_ht818.py` (422 l√≠neas)
   - Script de descubrimiento completo para HT818

2. `scripts/research/diagnose_device.py` (73 l√≠neas)
   - Herramienta de diagn√≥stico de dispositivos

### Archivos Modificados

1. `scripts/ont_automated_tester.py`
   - Agregado mapeo MOD006
   - Funci√≥n `_detect_device_type()`
   - Funci√≥n `_login_grandstream()`
   - Funci√≥n `_login_ont_standard()` (refactorizada)

2. `scripts/run_all_tests.py`
   - Agregado MOD006 a `SUPPORTED_MODELS`

### Archivos Generados (Pruebas)

1. `ht818_discovery_11_11_25_171636.json`
2. `ht818_discovery_11_11_25_171636.txt`

---

## üéì Aprendizajes Clave

### Diferencias Arquitecturales

1. **ONTs usan AJAX endpoint unificado** con par√°metro `ajaxmethod`
2. **HT818 usa m√∫ltiples endpoints CGI** espec√≠ficos
3. **Detecci√≥n por contenido HTML** es m√°s confiable que por endpoints
4. **Grandstream no usa el mismo protocolo** que ONTs Fiberhome/Huawei/ZTE

### Proceso de Integraci√≥n

1. **Siempre verificar qu√© dispositivo est√° conectado** antes de asumir
2. **Usar herramientas de diagn√≥stico** para validar
3. **La detecci√≥n autom√°tica requiere m√∫ltiples heur√≠sticas**
4. **Cada fabricante tiene su propia arquitectura** de APIs

### Testing Multi-Dispositivo

1. **No todos los tests aplican a todos los dispositivos**
   - ONT: WiFi, PON, USB
   - ATA: VoIP, FXS ports, SIP registration

2. **La metadata debe adaptarse al tipo**
   - ONT: Serial Number (l√≥gico + f√≠sico)
   - ATA: MAC Address

3. **Los reportes deben ser espec√≠ficos** al tipo de dispositivo

---

**Autor:** Paul  
**√öltima actualizaci√≥n:** 11 de noviembre de 2025, 17:25  
**Estado:** Soporte HT818 implementado - Pendiente de pruebas con dispositivo real  
**Dispositivo usado en pruebas:** ONT Fiberhome HG6145F1 (192.168.100.1)
